# 飞书多维表格配置说明（新版API）

## 架构概览

本项目采用 FastAPI + COZE插件 架构，COZE插件调用FastAPI完成数据清洗合并，然后写入飞书多维表格。

## 新版特性（基于lark_oapi）

1. ✅ **官方API**: 使用飞书官方lark_oapi库
2. ✅ **动态字段映射**: 自动获取字段列表，无需手动配置
3. ✅ **类型智能处理**: 自动处理Text/Number/DateTime/Select等所有字段类型
4. ✅ **批量写入**: 支持最多500条记录批量写入
5. ✅ **配置验证**: 写入前自动验证配置完整性

## 配置方法

### COZE插件配置

在COZE插件中配置以下参数：

```
feishu_enabled: true  # 启用飞书写入
feishu_app_id: "cli_xxxxxxxxxxxx"  # 飞书应用ID
feishu_app_secret: "xxxxxxxxxxxx"  # 飞书应用密钥
feishu_app_token: "PsA5bq3OOaeHMQspbdtcKc1gnfd"  # 多维表格token
feishu_table_id: "tblxxxxxxxxxxxx"  # 表格ID
```

## 字段映射规则

系统会根据表格实际字段自动映射，支持以下字段名：

| 英文键名 | 中文字段名 |
|---------|-----------|
| NSC_CODE | 主机厂经销商ID |
| level | 层级 |
| store_name | 门店名 |
| natural_leads_total | 自然线索总量 |
| ... | ... |

## 表格结构要求

### NSC_CODE聚合
- 必须包含：`主机厂经销商ID`
- 可选包含：`层级`、`门店名`等

### level聚合  
- 必须包含：`层级`
- 可选包含：其他相关字段

注意：系统会根据实际表格字段自动匹配，不需要的字段会自动跳过。

## 字段映射规则

系统会自动将英文键名映射到对应的中文字段名：

| 英文键名 | 中文字段名 |
|---------|-----------|
| NSC_CODE | 主机厂经销商ID |
| level | 层级 |
| store_name | 门店名 |
| natural_leads_total | 自然线索总量 |
| ad_leads_t | T月广告线索量 |
| ... | ... |

## 数据类型处理

系统会根据飞书字段类型自动处理数据：

- **Text**: 自动转换为字符串
- **Number**: 自动转换为浮点数，支持百分比、货币等格式
- **DateTime**: 自动转换为毫秒时间戳
- **SingleSelect**: 自动匹配选项ID
- **MultiSelect**: 自动处理多个选项
- **Checkbox**: 自动转换为布尔值

## 调试工具

### 1. 验证表格结构

```bash
python -c "
from feishu_writer_v2 import FeishuWriterV2
import asyncio

async def test():
    writer = FeishuWriterV2({
        'enabled': True,
        'app_id': 'your_app_id',
        'app_secret': 'your_secret',
        'app_token': 'your_token',
        'table_id': 'your_table_id'
    })
    
    result = await writer.validate_config('NSC_CODE')
    print('验证结果:', result)

asyncio.run(test())
"
```

### 2. 查看字段映射

```bash
python -c "
from feishu_table_manager import FeishuTableManager
import asyncio

async def test():
    manager = FeishuTableManager('app_id', 'app_secret', 'app_token')
    manager.set_table_id('NSC_CODE', 'your_table_id')
    manager.print_field_mapping('NSC_CODE')

asyncio.run(test())
"
```

## 常见问题

### 1. 配置验证失败
- 检查app_id、app_secret、app_token是否正确
- 检查table_id是否对应正确的维度
- 确保应用有访问多维表格的权限

### 2. 字段写入失败
- 检查表格是否包含对应的中文字段名
- 检查字段类型是否匹配数据格式
- 查看日志中的详细错误信息

### 3. 数据格式错误
- 确保数值字段传入的是数字类型
- 确保日期字段传入的是有效日期
- 确保选择字段的值存在于选项中

## 迁移说明

从旧版httpx API迁移到新版lark_oapi：

1. ✅ 自动兼容旧配置格式
2. ✅ 无需修改COZE插件配置
3. ✅ 自动处理字段映射
4. ✅ 提供更好的错误提示

## 日志说明

日志中会显示以下信息：
- 字段获取结果
- 数据映射详情
- 写入批次进度
- 成功/失败统计